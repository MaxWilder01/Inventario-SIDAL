<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Inventario</title>

    <!-- FONTS -->
    <!--------------------------------------------------------------------------->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

    <!-- ICON -->
    <!--------------------------------------------------------------------------->

    <link rel="shortcut icon" type="image/png" href="img/rocket.png">

    <!-- JQUERY -->
    <!--------------------------------------------------------------------------->

    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/jquery.dataTables.min.js"></script>

    <!-- BOOTSTRAP -->
    <!--------------------------------------------------------------------------->

    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
      crossorigin="anonymous">

    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
      integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
      crossorigin="anonymous">

    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
      integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
      crossorigin="anonymous">
    </script>

    <!-- FIREBASE -->
    <!--------------------------------------------------------------------------->

    <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
    <script>
      var config = {
        apiKey: "AIzaSyCpyqlBvZRhGVLjSPcmy_D7P71LDwxkmVE",
        authDomain: "inventario-b4de2.firebaseapp.com",
        databaseURL: "https://inventario-b4de2.firebaseio.com",
        projectId: "inventario-b4de2",
        storageBucket: "inventario-b4de2.appspot.com",
        messagingSenderId: "869466702076"
      };
      firebase.initializeApp(config);
    </script>

    <!-- DATATABLES -->
    <!--------------------------------------------------------------------------->

    <link rel="stylesheet" href="css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.1/js/buttons.html5.min.js">

    <!-- JSPDF -->
    <!--------------------------------------------------------------------------->

    <script src="js/jspdf.min.js"></script>

    <!-- LOCAL -->
    <!--------------------------------------------------------------------------->

    <script src="js/datos.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/styles.css">

    <!-- SCRIPT CONFIGURACIÓN DATATABLES -->
    <!--------------------------------------------------------------------------->

    <script>
    var a = [];
    $(document).ready(function()
      {
        $('#tabla-datos').dataTable( {
          "columnDefs": [
            { "orderable": false, "targets": '_all' }
          ],
          "bLengthChange": false,
          createdRow: function ( tr ) {
              $('.editar', tr).on('click', editarDato);
              $('.borrar', tr).on('click', borrarDato);
          },
          createdCell: function () {
            $('.editar', tr).on('click', editarDato);
            $('.borrar', tr).on('click', borrarDato);
          },
          "language": {
            "lengthMenu": "Mostrar _MENU_ registros por página",
            "zeroRecords": "</br>",
            "info": "Página _PAGE_ de _PAGES_",
            "infoEmpty": "",
            "infoFiltered": "",
            "search":         "",
            "paginate": {
              "first":      "Primera",
              "last":       "Última",
              "next":       "Siguiente",
              "previous":   "Anterior"
            }
          },
          "pageLength" : 13
       });

      var rootRef=firebase.database().ref().child("datos")
      var table = $('#tabla-datos').DataTable();

      //------------------------------- AGREGAR ------------------------------//

      rootRef.on("child_added",snap => {
      var dataSet = [snap.child("nombre").val(),
                     snap.child("sector").val(),
                     snap.child("cantidad").val(),
                     snap.child("valor").val(),
                     '<button id="btn-editar" class="btn btn-warning btn-xs editar" data="'
                     + snap.key +'"><span class="glyphicon glyphicon-pencil"></span></button>',
                     '<button class="btn btn-danger btn-xs borrar" data="'
                     + snap.key +'"><span class="glyphicon glyphicon-trash"></span></button>'];

      table.rows.add([dataSet]).nodes()
                               .to$()
                               .addClass(snap.key);
      table.draw();
      });

      //------------------------------- EDITAR ------------------------------//

      rootRef.on("child_changed", snap => {
        var nombre = snap.child("nombre").val();
        var sector = snap.child("sector").val();
        var cantidad = snap.child("cantidad").val();
        var valor = snap.child("valor").val();

        document.getElementsByClassName(snap.key)[0].innerHTML =
         "<tr id='" + snap.key +"'>" +
            "<td class='sorting_1'>" + snap.child("nombre").val() + "</td>"+
            "<td>" + snap.child("sector").val() + "</td>"+
            "<td>" + snap.child("cantidad").val() + "</td>"+
            "<td>" + snap.child("valor").val() + "</td>"+
            "<td>" +'<button id="btn-editar" class="btn btn-warning btn-xs editar" data="'
            + snap.key +'"><span class="glyphicon glyphicon-pencil"></span></button>' + "</td>"+
            "<td>" + '<button class="btn btn-danger btn-xs borrar" data="'
            + snap.key +'"><span class="glyphicon glyphicon-trash"></span></button>' + "</td>"+
          "</tr>";

          $(".editar").on("click", editarDato);
          $(".borrar").on("click", borrarDato);
      });

      });
    </script>
  </head>
  <body>
    <div class="container">
      <nav>
        <a style="color: white; text-decoration: none" href="index.html">
          <img src="img/rocket.png" style="width: 30px; height: 30px;" alt="">
          <div style="width: 5px;"></div>
          <h2 style="padding-top: 5px;">Inventario SIDAL</h2>
        </a>
        <button style="border: none; background: #2E7D32; margin-top: 30px; margin-right: 20px; float: right;" type="button" class="btn btn-success btn-sm" name="button">GENERAR EXCEL</button>
        <button style="border: none; background: #D50000; margin-top: 30px; margin-right: 20px; float: right;" type="button" class="btn btn-success btn-sm" id="btn-pdf" name="button">GENERAR PDF</button>
      </nav>
      <div id="modal" class="modal">
        <div class="modal-content">
          <span style="font-size: 25pt; margin-top: -10px;" class="close">&times;</span>
          <form id="form-datos">
            <div class="form-group">
              <label for="nombre">Nombre</label>
              <input type="text" name="nombre" value="" id="nombre" class="form-control">
            </div>
            <div class="form-group">
              <label for="sector">Sector</label>
              <input type="text" name="sector" value="" id="sector" class="form-control">
            </div>
            <div class="form-group">
              <label for="cantidad">Cantidad</label>
              <input type="text" name="cantidad" value="" id="cantidad" class="form-control">
            </div>
            <div class="form-group">
              <label for="valor">Valor</label>
              <input type="text" name="valor" value="" id="valor" class="form-control">
            </div>
            <input type="submit" name="enviar" value="Agregar" class="btn btn-primary btn-block btn-lg" id="btn-enviar">
          </form>
        </div>
      </div>
      <div class=" col-sm-12 row" id="row">
        <div class="col-sm-12 card">
          <h3>Productos Agrícolas</h3>
          <table id="tabla-datos" class="table table-hover compact">
            <thead>
              <tr>
                <th class="col-sm-3">Nombre</th>
                <th class="col-sm-3">Sector</th>
                <th class="col-sm-2">Cantidad</th>
                <th class="col-sm-2">Valor</th>
                <th class="col-sm-1"></th>
                <th class="col-sm-1">
                  <button type="button" name="button" class="btn btn-success btn-xs glyphicon glyphicon-plus" id="btn-agregar"></button>
                </th>
              </tr>
            </thead>
            <tbody id="tbody-tabla-datos">
              <div style="margin-top: 20px" id="preloader">
                  <div id="loader"></div>
              </div>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </body>
</html>
